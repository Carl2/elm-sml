#+OPTIONS: broken-links:t
#+author: calle
#+title: FSM
#+filetags: elm programming language web

#+HTML_HEAD: <link href="extra/prism.css" rel="stylesheet" />

For more information of how *SML* works,checkout [[https://github.com/boost-ext/sml][link sml]].

#+begin_export html

<div id="elm-app"></div>
<div id="encoded-data"></div>
<img id="plantuml-img"></div>

<script src="https://cdn.jsdelivr.net/npm/plantuml-encoder@1.4.0/dist/plantuml-encoder.min.js"></script>
<script src="extra/prism.js"></script>
<script src="elm.js"></script>
<script>
    var app = Elm.Main.init({
      node: document.getElementById("elm-app")
    });

    // Port handler for syntax highlighting
    // Debounce to avoid excessive calls and use highlightElement instead of highlightAll
    var highlightTimeout = null;
    app.ports.highlightCode.subscribe(function() {
        // Clear any pending highlight
        if (highlightTimeout) {
            clearTimeout(highlightTimeout);
        }
        // Debounce: wait 300ms after last keystroke before highlighting
        highlightTimeout = setTimeout(function() {
            // Get the code elements
            var cppOutput = document.getElementById('cpp-output');
            var eventOutput = document.getElementById('event-output');
            
            // Re-highlight by getting the text content and re-setting it
            // This prevents Prism from accumulating highlighted content
            if (cppOutput) {
                var cppText = cppOutput.textContent;
                cppOutput.innerHTML = cppText;
                Prism.highlightElement(cppOutput);
            }
            if (eventOutput) {
                var eventText = eventOutput.textContent;
                eventOutput.innerHTML = eventText;
                Prism.highlightElement(eventOutput);
            }
        }, 300);
    });

    // Port handler for PlantUML diagram
    app.ports.sendDiagram.subscribe(function(data) {
        console.log("Data from Elm: ", data);

        var plantumlEncoder = window.plantumlEncoder;
        var encoded_data = plantumlEncoder.encode(data);

        var baseUrl = 'http://www.plantuml.com/plantuml/img/';
        var url = baseUrl + encoded_data;
        document.getElementById('plantuml-img').src = url;
    });

    // Port handler for Compiler Explorer (godbolt.org)
    app.ports.openCompilerExplorer.subscribe(function(code) {
        console.log("Opening Compiler Explorer with code");
        
        // Create the clientstate object for Compiler Explorer
        var clientState = {
            sessions: [{
                id: 1,
                language: "c++",
                source: code,
                compilers: [{
                    id: "clang_trunk",
                    options: "-std=c++20"
                }],
                executors: [{
                    compiler: {
                        id: "clang_trunk",
                        options: "-std=c++20"
                    }
                }]
            }]
        };
        
        // Base64 encode the clientstate
        var jsonString = JSON.stringify(clientState);
        var base64 = btoa(unescape(encodeURIComponent(jsonString)));
        
        // URL-safe base64
        var urlSafeBase64 = base64.replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
        
        // Open Compiler Explorer in a new tab
        var url = 'https://godbolt.org/clientstate/' + urlSafeBase64;
        window.open(url, '_blank');
    });

    // Initial highlighting after page load
    document.addEventListener('DOMContentLoaded', function() {
        Prism.highlightAll();
    });
</script>

#+end_export
